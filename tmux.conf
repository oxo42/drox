# Tmux settings

###########################################################################
# General options

# Default termtype. If the rcfile sets $TERM, that overrides this value.
set -g default-terminal screen-256color
# set -g default-terminal xterm

# Watch for activity in background windows
setw -g monitor-activity on

# scrollback size
set -g history-limit 10000
set -g display-time 4000

# Fix vim escape time
set -s escape-time 0

# set first window to index 1 (not 0) to map more to the keyboard layout
set -g base-index 1
setw -g pane-base-index 1


###########################################################################
# Window management / navigation

# move between windows
bind-key -r C-h previous-window
bind-key -r C-l next-window
bind-key -n C-Space next-window

# C-b C-b to skip to last window we were in before this one
bind-key C-b last-window


###########################################################################
# General keymap

# Keep your finger on ctrl, or don't, same result
# bind-key C-d detach-client
bind-key C-p paste-buffer

# Redraw the client (if interrupted by wall, etc)
bind R refresh-client

# reload tmux config
unbind r
bind r \
    source-file ~/.tmux.conf \; \
    display 'Reloaded tmux config.'

# Use vi keybindings in copy and choice modes
setw -g mode-keys vi

###########################################################################
# Pane management / navigation

# Horizontal splits with s or C-s
unbind s
unbind C-s
bind-key s split-window
bind-key C-s split-window

# Vertical split with v or C-v
unbind v
unbind C-v
bind-key v split-window -h
bind-key C-v split-window -h

# Remap pane navigation to vim
# unbind-key -n M-j
# bind-key -n M-j select-pane -D
#
# unbind-key -n M-k
# bind-key -n M-k select-pane -U
#
# unbind-key -n M-h
# bind-key -n M-h select-pane -L
#
# unbind-key -n M-l
# bind-key -n M-l select-pane -R

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n M-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
bind-key -n M-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
bind-key -n M-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
bind-key -n M-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
bind-key -n M-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"


# Pane resize in all four directions using vi bindings.
bind-key -r J resize-pane -D "10"
bind-key -r K resize-pane -U "10"
bind-key -r H resize-pane -L "10"
bind-key -r L resize-pane -R "10"

# easily toggle synchronization (mnemonic: e is for echo)
# sends input to all panes in a given window.
bind e setw synchronize-panes on
bind E setw synchronize-panes off

###########################################################################
# Scrollback / pastebuffer

# Vim-style copy/paste
# unbind [
# bind y copy-mode
# unbind p
# bind p paste-buffer
bind -t vi-copy v begin-selection
bind -t vi-copy y copy-selection

bind -n S-PageUp copy-mode -eu
bind -n S-PageDown copy-mode -ed

###########################################################################
# Mouse mode is off by default.
# <prefix> M -- to turn it off
# <prefix> m -- to turn it on
#
# As of tmux 2.1, a backward-incompatible change was introduced.
# mode-mouse and mouse-* no longer exist, replaced by simply
# mouse <on|off>. Which is great, and easier, but unfortunately I use
# tmux on systems which I don't foresee going to 2.1+ anytime soon.
# So, time to test versions... this is kind of cheap and hacky, and it
# won't work for 2.2 and beyond, but will work for now. I tried to make
# this more generalized but have not been successful so far.
#


if-shell '[[ $(echo "$(tmux -V | cut -d" " -f2) >= 2.1" | bc) -eq 1 ]]' \
    'bind m set -g mouse on \; display "Mouse ON"; bind M set -g mouse off \; display "Mouse OFF"' \
    'bind m set -g mode-mouse on \; set -g mouse-resize-pane on \; set -g mouse-select-pane on \; set -g mouse-select-window on \; display "Mouse ON"; bind M set -g mode-mouse off \; set -g mouse-resize-pane off \; set -g mouse-select-pane off \; set -g mouse-select-window off \; display "Mouse OFF"'

###########################################################################
# Powerline
source "/usr/lib/python2.7/site-packages/powerline/bindings/tmux/powerline.conf"


# pane border
set-option -g pane-border-fg red
set-option -g pane-border-bg red
set-option -g pane-active-border-fg brightgreen
set-option -g pane-active-border-bg brightgreen

# message text
set-option -g message-bg black
set-option -g message-fg red

# pane number display
set-option -g display-panes-active-colour red
set-option -g display-panes-colour white

# clock
set-window-option -g clock-mode-colour cyan

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'tmux-plugins/tmux-yank'
# set -g @plugin 'tmux-plugins/tmux-sensible'

# Other examples:
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'git@github.com/user/plugin'
# set -g @plugin 'git@bitbucket.com/user/plugin'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
